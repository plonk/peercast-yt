{^define LAYOUT layout.html}
{^define TITLE}
  {#Channels} - {#PeerCast on} {^SERVER_NAME}
{^end}
{^define HEAD}
  <style>
   input, select { font-size: 9pt }
   .channel-list {
       font-family: Verdana, sans-serif; font-size: 9pt; color: #222; line-height: 1.3em; margin: 0;
       width:100%; max-width: 640px
    }
   .channel-list tr { background-color: #FFECC4 }
   .channel-list th { font-size: 9pt; padding: 3px 5px; color: black }
   .channel-list th a { color: inherit }
   .channel-list td { text-align: center; padding: 5px 5px; }
   .channel-list td.channel-description {
       text-align: left;
       overflow-wrap: break-word;
   }
   td.results { text-align: left }
   .link { color: blue }
   .em-link { color: blue; font-weight: bold }
   .container { background-color: white;
          margin-left: auto; margin-right: auto;
          border: solid 1px black; padding: 5px }
   .channel-name { font-size: 11pt; margin-bottom: 2px }
   .detail {  }
   .rank { font-size: 9pt }
   .listeners { padding-bottom: 3px }
   .icons { margin-top: 2px }
   .play-button { margin-left: 8px; margin-right: 8px }
   .channel-list .bitrate { text-align: right }
   .relay-list { width:100%; max-width: 640px }
   .relay-list th { white-space: nowrap }
   .accented { color: var(--accent-color) !important; }
   .muted { color: grey !important; }
    .sort-triangle { display:inline-block; min-width:1.5em }

    .channel-list td.channel-description a { display: block; text-decoration: none; max-width: 45vw }
    .channel-list th { cursor: pointer }
    {^DARK_THEME_STYLES_BEGIN}
        .channel-list { color: #ddd }
        .channel-list tr { background-color: #544827 }
        .channel-list th { color: #eee }
    {^DARK_THEME_STYLES_END}
  </style>
{^end}

  <script>
    function simplify(url)
    {
        return url.replace(/^https?:\/\//, '').replace(/\/$/, '')
    }


    function feednick(feed)
    {
        if (feed.url == "http://bayonet.ddo.jp/sp/index.txt")
            return "SP"
        else if (feed.url == "http://peercast.takami98.net/turf-page/index.txt")
            return "{#Turf}"
        else if (feed.url == "http://yp.pcgw.pgw.jp/index.txt")
            return "{#Heisei}"
        else if (feed.url == "https://p-at.net/index.txt")
            return "P@"
        else if (feed.url == "http://ypv6.pecastation.org/index.txt")
            return "YPv6"
        else if (feed.url == "http://eventyp.xrea.jp/index.txt")
            return "{#Event YP}"
        else
            simplify(feed.directoryUrl)
    }
  </script>

<div class="flex-container navbar" id="group_tab">
</div>

<div align=right>
  <a href="/admin?cmd=fetch_feeds" title="{#Auto-updates every 5 minutes. Manual updates have a cooldown of 30 seconds.}">{#Update}</a>
  <button onclick="$('#column_modal').show()" title="カラム表示の設定">&#x2699;&#xFE0F;</button>
</div>

<script>
  // チャンネルの詳細な情報を表示するモーダルにデータを設定。
  function showModal(chid)
  {
      const info = servMgr.channelDirectory.channels.find(ch => ch.id == chid)
      if (!info)
      {
          alert(`No info about ${chid} found`)
          return
      }
      $('#channel_modal').show()
      let buf = "<table>"
      console.log(info)
      for (const key in info)
      {
          buf += `<tr><th>${key}</th><td>${info[key]}</td></tr>`
      }
      buf += "</table>"
      console.log(buf)
      $('.modal #info').html(buf)
  }

  $(function(){
      // 全てのモーダルは、矩形の外をクリックすると閉じられる。
      $('.modal').on('click', function(){ $(this).hide() });
      $('.modal .modal-contents').on('click', (e) => e.stopPropagation());
  })
</script>

<div class="modal" id="channel_modal">
  <div class="modal-contents default-bg">
    <h3 style="margin:0">もーだるだよ。</h3>
    <div class="modal-body">
      <div id="info"></div>
    </div>
    <div class="modal-footer" style="margin-top:15px; text-align:right">
      <button onclick="$('#channel_modal').hide()">{#Close}</button>
    </div>
  </div>
</div>

{$
  define(COLUMNS,
         [
           ["name","{#Channel}","asc"],
           ["numDirects","{#Status}","desc"],
           ["uptime","{#Uptime}","desc"],
           ["bitrate","{#Bitrate}","desc"],
           ["contentTypeStr","{#Type}","asc"]
         ])
}

<div class="modal" id="column_modal">
  <div class="modal-contents default-bg">
    <h3 style="margin:0">{#Display Columns}</h3>
    <div class="modal-body" align="left">
      {@foreach COLUMNS}
        {@let key = nth(0,this), header = nth(1,this), order = nth(2,this)}
          <label style="display:block"><input type="checkbox" onchange='columnVisibility["{$key}"] = this.checked; savePreferences(); updateView()' data-key="{$key}" {$if(key == 'name', 'disabled')}> {$header}</label>
        {@end}
      {@end}
    </div>
    <div class="modal-footer" style="margin-top:15px; text-align:right">
      <!-- <input type="submit" value="{#Save}"> -->
      <button onclick="$('#column_modal').hide()">{#Close}</button>
    </div>
  </div>
</div>

<!-- index.txt の取得が5分ごとなので、あまり頻繁に更新しても仕方ない -->
<table class="channel-list">
</table>

<script>
  var columnVisibility = {}
  var sortColumn = null
  var sortOrder = null
  var selectedGroup = null

  // localStorageからコラムの表示に関するユーザー設定を取得して上のパラメータにセットする。
  function loadPreferences()
  {
      if (localStorage["columnVisibility"])
      {
          columnVisibility = JSON.parse(localStorage["columnVisibility"])
      }
      // チャンネル名は常に表示する。
      Object.assign(columnVisibility, { "name": true })

      sortColumn = localStorage["sortColumn"]
      sortOrder = localStorage["sortOrder"]
  }


  // localStorage に表示設定を保存。
  function savePreferences()
  {
      localStorage["columnVisibility"] = JSON.stringify(columnVisibility)
      localStorage["sortColumn"] = sortColumn
      localStorage["sortOrder"] = sortOrder
  }

  $(function(){
      loadPreferences()

      // カラム表示モーダルのチェックボックスの状態を設定する。
      for (const checkbox of $('#column_modal .modal-body input[type=checkbox]'))
      {
          if (columnVisibility[checkbox.dataset.key])
              checkbox.checked = true
          else
              checkbox.checked = false
      }
  })

// HTMLエスケープをする関数。
function h(str)
{
      return str.replace(/[&<>"']/g, (c) => ({'&': "&amp;", '<': "&lt;", '>': "&gt;", '\"': "&quot;", '\'': "&#39;"})[c])
}

// who。HTMLを書くための関数。
const NoCloseTagRequired = { 'img':true, 'br':true, 'meta':true, 'link':true }

function who(...args)
{
      let buf = ""
      let firstTime = true

      for (const arg of args)
      {
          if (firstTime)
              firstTime = false
          else
              buf += ' '

          if (typeof(arg) == 'string')
              buf += h(arg)
          else if (arg instanceof Array)
          {
              let buf2 = "";
              const [elem, attrs, ...inner] = arg
              if (!elem)
                  throw new Error("elem")
              if (elem == '!')
              {
                  buf += [attrs, ...inner].join('')
                  continue;
              }
              buf2 += `<${elem}`
              if (attrs && typeof(attrs) == 'object' && !(attrs instanceof Array))
              {
                  for (const key of Object.keys(attrs))
                  {
                      if (attrs[key] === true)
                          buf2 += ` ${key}`
                      else if (attrs[key] === false || attrs[key] === null)
                          buf2 += ''
                      else
                          buf2 += ` ${key}="${h(attrs[key])}"`
                  }
              }else
                  inner.unshift(attrs)
              buf2 += ">"
              buf2 += who(...inner)
              if (!NoCloseTagRequired[elem])
                  buf2 += `</${elem}>`
              buf += buf2
          } else
              throw new Error("Unknown type")
      }
      return buf;
}

// 実体参照を文字にするための関数。タグは除去される。重いかもしれない。
function unescapeHtml(str)
{
      return $($.parseHTML(str)).text()
}

function onColumnClicked(key, defaultOrder)
{
      if (sortColumn != key)
      {
          sortColumn = key
          sortOrder = defaultOrder
      } else
      {
          if (sortOrder == "asc")
              sortOrder = "desc"
          else
              sortOrder = "asc"
      }

      savePreferences()
      updateView()
}

// コラムのソート用比較関数1
function uptimeComparer(a,b)
{
    const [ah, am] = a.split(':')
    const [bh, bm] = b.split(':')
    return (+ah * 60 + +am) - (+bh * 60 + +bm)
}

// コラムのソート用比較関数2
function stringComparer(a,b)
{
    return (a === b) ? 0 : (a < b ? -1 : 1)
}

// コラムのソート用比較関数3
function numericComparer(a,b)
{
  return +a - +b
}

// getState RPC で取ってきたデータがここにささる。
var servMgr

// グループタブとチャンネルリストを再描画。
function updateView()
{
      updateGroup()
      updateTable()
}

// チャンネルリストの再描画。
function updateTable()
{
      const COLUMNS = {!COLUMNS}

      let channels = servMgr.channelDirectory.channels

      if (selectedGroup)
      {
          channels = channels.filter(channel => channel.feedUrl == selectedGroup)
      }

      let compr
      if (sortColumn == 'uptime')
          compr = (a,b) => uptimeComparer(a[sortColumn], b[sortColumn])
      else if (sortColumn == 'numDirects' || sortColumn == 'bitrate')
          compr = (a,b) => numericComparer(a[sortColumn], b[sortColumn])
      else
          compr = (a,b) => stringComparer(a[sortColumn], b[sortColumn])

      channels.sort(compr)

      if (sortOrder == "desc")
          channels.reverse()

      const html = who(
          ['tr',
           ... COLUMNS.flatMap(([key, header, order]) => 
               columnVisibility[key] ?
               [
                   ['th', { class: sortColumn == key ? "accented" : null, onclick: `onColumnClicked("${key}", "${order}"); updateView()` },
                    ['span', {}, header],
                    (sortColumn == key && sortOrder == "desc") ? ['span', { class: "sort-triangle" }, '▼'] : "",
                    (sortColumn == key && sortOrder == "asc") ? ['span', { class: "sort-triangle" }, '▲'] : "",
                    (sortColumn != key) ? ['span', { class: "sort-triangle" }, unescapeHtml('&nbsp;')] : ""]
               ] : [])
          ],
          ... channels.flatMap(channel =>
              [
                  ['tr',
                   columnVisibility['name'] ?
                   ['td', { class:"channel-description" },
                    ['button', { style:"float:right", onclick:`showModal('${channel.id}')`}, unescapeHtml('&#x2139;&#xfe0f;')],
                    ['a', { href: channel.id != "00000000000000000000000000000000" ? `play.html?id=${channel.id}` : null }, 
                     // name, genre, desc はエスケープ済みなので一度アンエスケープする。
                     ['div', { class:"channel-name" }, unescapeHtml(channel.name)],
                     ['div', { class:"detail text-muted"}, (channel.genre ? `${unescapeHtml(channel.genre)} - ` : ''), unescapeHtml(channel.desc)],
                    ],
                   ] : '',
                   columnVisibility['numDirects'] ?
                   ['td', { align:'center', nowrap:true },
                    ['span', { class:"listeners" }, `${channel.numDirects}/${channel.numRelays}`],
                    channel.encodedName ? ['div', { class:"icons"},
                                           ['a', { href:channel.chatUrl}, ['img', { alt:"Chat", src:"/assets/images/chat.png"}]],
                                           ['a', { href: channel.statsUrl}, ['img', { alt:"Stats", src:"/assets/images/graph.png"}]]] : ''] : '',

                   columnVisibility['uptime'] ?
                   ['td', { align:'center', nowrap:true }, channel.uptime] : '',

                   columnVisibility['bitrate'] ?
                   ['td', { class:"bitrate", align:'center', nowrap:true }, `${channel.bitrate} kb/s`] : '',

                   columnVisibility['contentTypeStr'] ?
                   ['td', { align:'center' }, channel.contentTypeStr] : '',
                  ]
              ]
          )
      )

      $('.channel-list').html(html)
}

// グループタブの更新。
  function updateGroup()
  {
      const html = who(
          ['a', { class: !selectedGroup ? 'active-tab' : null, onclick:`selectedGroup = null; updateView()`, style:"cursor: pointer" }, `{#All} (${servMgr.numExternalChannels})`],
          ... servMgr.channelDirectory.feeds.map((feed) =>
              ['a', {class: selectedGroup==feed.url ? 'active-tab' : null, onclick:`selectedGroup = '${feed.url}'; updateView()`, style: "cursor:pointer; text-overflow: ellipsis; white-space: nowrap; overflow: hidden", title:`${feednick(feed)} (${feed.numChannels})` }, `${feednick(feed)} (${feed.numChannels})`])
      )

      $('#group_tab').html(html)
  }

$(function(){
      // チャンネルリストを取得して描画する。
      const request = {
          "jsonrpc": "2.0",
          "method": "getState",
          "params": [["servMgr"]],
          "id": null
      }
      fetch("/api/1", { method: 'POST', body: JSON.stringify(request) })
      .then(response => response.json())
      .then(data => {
          console.log(data.result)
          servMgr = data.result.servMgr
          updateView()
      })
      .catch(error => {
          console.error(error)
      })
})
</script>


